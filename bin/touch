#!/bin/bash

set -euo pipefail

function usage() {
  echo "Usage: $(basename $0) [OPTIONS] /path/to/file"
  echo ""
  echo "Selecting a filetype like executable or library is mandatory!"
  echo ""
  echo "Options:"
  echo "  -e, -x  Create executable script"
  echo "  -h      Show this information"
  echo "  -l      Create library file"
}

function create_header() {
  if [[ "${description}" ]]; then
    echo "# ${description}"
  fi

  if
    [[ "${description}" ]] && \
    (
      [[ "${author_email}" ]] || \
      [[ "${author_name}" ]] || \
      [[ "${copyright}" ]]
    )
  then
    echo "#"
  fi

  if [[ "${copyright}" ]]; then
    echo "# Copyright ${copyright}"
  fi

  if [[ "${author_email}" ]] && [[ "${author_name}" ]]; then
    echo "# Author: ${author_email} (${author_name})"
  fi

  if [[ ! "${author_email}" ]] && [[ "${author_name}" ]]; then
    echo "# Author: ${author_name}"
  fi
}

function escape_string() {
  echo $(basename "$1") \
    | tr -cs '[:alnum:]\n\r' '_' \
    | tr '[:upper:]' '[:lower:]'
}

function executable_content() {
  local -r header=$(create_header)
  local -r libpath=$(
    realpath --relative-to=$(dirname "${filename}") "${script_dir}/../lib"
  )

  echo "#!/bin/bash"

  if [[ "${header}" ]]; then
    echo "#"
    echo "${header}"
  fi

  echo ''
  echo 'set -euo pipefail'
  echo ''
  echo 'function main() {'
  echo '  readonly script_dir=$(readlink -f $(dirname "${BASH_SOURCE[0]}"))'
  echo ''
  echo "  source \"\${script_dir}/${libpath}/init.sh\""
  echo ''
  echo '  echo "Hello world"'
  echo '}'
  echo ''
  echo 'main "$@"'
}

function handle_path() {
  filename="$1"
  local -r extension="${filename: -3}"

  if ! (( ${executable} )) && [[ "${extension}" == ".sh" ]]; then
    libname="${filename:0:-3}"
    libname=$(escape_string "${filename:0:-3}")
  fi

  if ! (( ${executable} )) && [[ "${extension}" != ".sh" ]]; then
    libname=$(escape_string "${filename}")
    filename="${filename}.sh"
  fi

  if (( ${executable} )) && [[ "${extension}" == ".sh" ]]; then
    chalk -l warn "Executables should have no extension"

    if query::polar "Remove extension '.sh'?"; then
      filename="${filename:0:-3}"
    else
      filename="${filename}"
    fi
  fi

  if [[ -d "${filename}" ]]; then
    chalk -l error "Specified path is a directory" >&2
    exit 1
  fi

  if
    [[ -f "${filename}" ]] && \
    ! query::polar "Specified file already exists. Overwrite?"
  then
    chalk -l warn "Omitting existing file '${filename}'"
    exit
  fi
}

function library_content() {
  local -r header=$(create_header)

  if [[ "${header}" ]]; then
    echo "${header}"
    echo ""
  fi

  echo "#######################################"
  echo "# Description of the function."
  echo "# Globals:"
  echo "#   (List of global variables used and modified.)"
  echo "#   BACKUP_DIR"
  echo "# Arguments:"
  echo "#   (Arguments taken.)"
  echo "#   None"
  echo "# Outputs:"
  echo "#   (Output to STDOUT or STDERR.)"
  echo "#   Writes location to stdout"
  echo "# Returns:"
  echo "#   (Returned values other than the default exit" \
    "status of the last command run.)"
  echo "#   0 if thing was deleted, non-zero on error."
  echo "#######################################"
  echo "function ${libname}::my_func() {"
  echo "  echo \"Hello world\""
  echo "}"
}

function query_header() {
  query -o -v description "Description"

  if query::polar -n "Add author information?"; then
    query::email -o -v author_email "Author email"
    query -d "${USER}" -v author_name "Author name"
  fi

  if query::polar -n "Add copyright information?"; then
    query \
      -d "$(date +'%Y') ${author_name:-$USER}" \
      -v copyright \
      "Copyright information"
  fi
}

function main() {
  declare -g author_email=""
  declare -g author_name=""
  declare -g copyright=""
  declare -g description=""
  declare -g executable
  declare -g filename=""
  declare -g libname=""

  while getopts 'ehlx' flag; do
    case "${flag}" in
      e|x) executable=1 ;;
      h) usage && exit 0 ;;
      l) executable=0 ;;
      *) usage && exit 1 ;;
    esac
  done

  shift $(( ${OPTIND} - 1 ))

  if [[ ! "${1-}" ]] || [[ ! "${executable-}" ]]; then
    usage >&2
    exit 1
  fi

  readonly script_dir=$(readlink -f $(dirname "$0"))

  source "${script_dir}/../lib/init.sh"

  butils::use chalk
  butils::use query

  handle_path "$1"

  local -r target=$(readlink -m "${filename}")

  mkdir -p $(dirname "${target}")
  rm -f "${target}"

  query_header

  if (( ${executable} )); then
    executable_content > "${target}"
    chmod +x "${target}"
    chalk -l success "Successfully created executable '${target}'"
  else
    library_content > "${target}"
    chmod -x "${target}"
    chalk -l success "Successfully created library file '${target}'"
  fi
}

main "$@"
